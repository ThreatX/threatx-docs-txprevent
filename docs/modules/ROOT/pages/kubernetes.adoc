= Installing TX Prevent on Kubernetes : Helm Chart
:description: Step-by-step guide to deploying the {product-name} sensor and control plane services into a Kuberntes environment.
:imagesdir: ../images
:favicon: images/favicon.png
// Page attributes
:page-category: Installation
:page-module: ROOT
:page-origin-type: git
:page-edit-url: https://github.com/ThreatX/txprevent-docs/edit/main/docs/modules/ROOT/pages/kubernetes.adoc
:page-product-name:  {product-name}
:page-pdf-filename: installing-tx-prevent-on-kubernetes-helm-chart.pdf
:env-sensor-target-environment: k8s-sidecar
:prereqs-k8s-version: >=1.22.0-0

== ðŸ‘‹ Introduction


This document will guide you through an installation of {product-name} into your Kubernetes environment.

image::threatx-prevent-control-plane.png[width=60%,align=center,Title="ThreatX Control Plane Services and Sensor Sidecar Injector"]


== ðŸš€ Helm Chart

ThreatX maintains a Helm chart to provide the best installation experience.
If you are not familiar with Helm, please take a moment to familiarize yourself with the https://helm.sh/docs[Helm documentation].

=== ðŸ“‹ Prerequisites

*  Kubernetes version `{prereqs-k8s-version}`
*  https://www.threatx.com/documentation/using-threatx/threatx-administrator-guide/#generating-and-revoking-sensor-api-keys[ThreatX Sensor API Key]
*  https://kubernetes.io/docs/tasks/tools[Kubectl CLI]
*  https://helm.sh/docs/intro/install[Helm CLI]


.Check Kubernetes Environment
====
[,console]
----
$ kubectl version
----
.Example Output
    Client Version: v1.30.1
    Kustomize Version: v5.0.4-0.20230601165947-6ce0bf390ce3
    Server Version: v1.29.4-eks-036c24b

====

'''

=== ðŸ“¥ Install {product-name}


A helm chart named `threatx-prevent` installs the ThreatX  _Control Plane Services_ and _Sensor Sidecar Injector_ into the `threatx` namespace of the Kubernetes cluster.


[,console]
.Installing the Helm Chart
----
include::example$install-helm-chart.sh[]
----
<.> The `<SENSOR_KEY>` authenticates the sensor's connection with _ThreatX Gateway_. It should not to be confused with a user's key to the _ThreatX API_. (_See:  https://www.threatx.com/documentation/using-threatx/threatx-administrator-guide/#generating-and-revoking-sensor-api-keys[Generate Sensor API Keys]_)
<.> The `<TENANT>` is your ThreatX tenant (customer) name.
<.> See <<application-name, Application Name>>
<.> The {product-name} services *requires TLS.* Use https://cert-manager.io[Cert Manager] (`true`) or Helm Long-Term Self-Signed Certificate Provisioning (`false`).



[TIP]
.Helm Tips
====
* Use the `--debug` switch to see all the Kubernetes configuration being applied by the chart.
* Use the `--dry-run` switch to validate the helm install without actually applying the changes.
====


.ðŸ“„ Using a Values File
****
Once you know the values you want to use, you can create a `values.yml` file with the values and use the `-f` switch to install the chart (rather than `--set`).

.values.yml
[,yaml]
----
include::example$helm-values.yml[]
----

CAUTION: This will be sufficient for most installations. Additional configuration options can be found in the <<_full_helm_configuration_reference,Full Helm Configuration Reference>>. Change at your own risk or contact ThreatX support for assistance.
****


==== ðŸ“¤ Uninstall {product-name}

The commands in this section demonstrate complete removal of the {product-name} control plane and sensors from your Kubernetes cluster


[,console]
.Remove the control plane
----
$ helm -n threatx uninstall threatx-prevent
----

[,console]
.Remove namespace
----
$ kubectl delete namespace threatx
----

NOTE: Sensor containers will not be removed until the application pods are restarted.


[,console]
.Restart application pods to remove ThreatX sensors
----
$ kubectl -n my-namespace rollout restart deployment/my-application
----


[[upgrading-threatx-prevent,Upgrading {product-name}]]
==== ðŸ‘† Upgrading {product-name}

Use `helm upgrade` to upgrade your version of {product-name}.


[,console]
.Upgrade ThreatX deployment
----
$ kubectl -n my-namespace rollout restart deployment/my-application
----

IMPORTANT: If the upgrade contains a new {product-name} sensor version you will need to restart your application pods to have the new sensors injected.

<<<

== ðŸš§ Configuration

This section will help you setup the _Control Plane Services_, enable _Sensor Sidecar Injector_, provision TLS certificates and define the application name.


[[sidecar-injector-certificates,Sidecar Injector Certificates]]
=== ðŸ’‰ Sidecar Injector

The _Sidecar Injector_ is a https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/[Kubernetes Mutating Admission Webhook] service that will inject ThreatX the sensor containers into application pods.

.Automatically inject the sidecar into any pods created with this label

    inject-threatx-sidecar: "true"


.Disable sidecar injection at the namespace level

    config.threatx.io/admission-webhooks: disabled


NOTE: Sidecar injection is always disabled for the `kube-system` namespace.


=== ðŸ“¡ Analyzer & Scanning Template Service (STS)

'''

[[external-secrets,External Secrets]]
==== ðŸ” External Secrets
If you choose to manage the Runtime Analyzer CA and certificate secrets outside of the Helm chart, you must use these names and set the `externalSecret` property to `true`.

[horizontal]
Certificate Authority (CA) Names::  `threatx-analyzer-ca-tls` or `threatx-sts-ca-tls`
TLS Secret (certificate) Names:: `threatx-analyzer-server-tls` or `threatx-sts-server-tls`

.values.yml
[,yaml]
----
include::example$helm-values-fragment-external-secrets.yml[]
----


'''

<<<

[[self-managed-certificates,Self Managed Certificates]]
==== ðŸ’ª Self Managed Certificates

If you want to provision the Analyzer's or STS certificate authority, pass the values into the Helm with the properties below.

IMPORTANT: These values must be provided as *base64* encoded strings.

.values.yml
[,yaml]
----
include::example$helm-values-fragment-self-managed-certs.yml[]
----


===== ðŸ”– Certificate Renewal

To renew the self-signed certificates perform a `helm upgrade` with a configuration property of `renewCerts=true`.  After the upgrade command runs you will need to restart the control plane services:

[,console]
----
$ kubectl -n threatx rollout restart deployment/threatx-analyzer
$ kubectl -n threatx rollout restart deployment/threatx-sts
----

All application pods with sensors will also need to be restarted (See <<upgrading-threatx-prevent,Upgrading {product-name}>>)

'''

<<<

[[application-name,Application Name]]
=== ðŸ·ï¸ Application Name

For the most accurate tracking of events at the application level the ThreatX Protect sensor needs to derive the name of the application that is monitoring in the pod.
This is done by looking at the pod labels.

The `applicationNameLabels` property in the Helm chart is a list of strings that are used to derive the application name. The default list is:

* `app.kubernetes.io/name`
* `app`
* `name`

If your application uses a different label for the application name, you can add it to the list as a helm configuration property.

image::threatx-prevent-sensor-tags-ctrlx.png[Sensor Tags, align=center,title="Derived application name(s) seen as _Tags_ on the ThreatX _Sensors_ page."]

NOTE: Each the _Deployed Sensors_ represents a single instance of *Analyzer*, which in turn can have multiple connected sensors.


[appendix]
== Helm Chart Configuration Reference

[%collapsible%closed]
.(Show or Hide) All Helm Properties
====
include::partial$helm-configuration-reference.adoc[]
====